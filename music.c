#include "minimath.h"
#include <stdint.h>
#define SONG_FREQUENCY 32000
#define MUSIC_BPM 144
#define MUSIC_CHANNELS 4
#define MUSIC_LENGTH 1092

static const char bbsong_data[] = "80a50a80a50a805af0a50bf1a73cf3c7g0a80ag0a80ag08ag0a80ag0f137c3578db5db8da5dbfd5a7ce3ce7ce3ec875fg0a80ag0a80ag08ag0a80ag0f137c357";

typedef struct
{
    uint8_t sustain, release;
    uint8_t waveform, transpose, volume; // 0-3
    uint8_t filtType, filtFreq;
    uint8_t pitchDrop; // 0-128, 0 no drop
} SynthParams;

static const uint8_t noteData[] = {192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 192, 192, 192, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 192, 192, 192, 192, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 192, 192, 192, 192, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 192, 192, 192, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 192, 192, 192, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 192, 192, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

SynthParams synthParams[] = {
    {.sustain = 66, .release = 32, .waveform = 0, .transpose = 58, .volume = 104, .filtType = 0, .filtFreq = 2, .pitchDrop = 81},
    {.sustain = 128, .release = 128, .waveform = 2, .transpose = 69, .volume = 128, .filtType = 1, .filtFreq = 2, .pitchDrop = 0},
    {.sustain = 0, .release = 68, .waveform = 1, .transpose = 69, .volume = 20, .filtType = 0, .filtFreq = 26, .pitchDrop = 0},
    {.sustain = 104, .release = 0, .waveform = 1, .transpose = 69, .volume = 22, .filtType = 1, .filtFreq = 64, .pitchDrop = 0},
    {.sustain = 0, .release = 64, .waveform = 0, .transpose = 57, .volume = 50, .filtType = 1, .filtFreq = 54, .pitchDrop = 0},
    {.sustain = 66, .release = 32, .waveform = 1, .transpose = 93, .volume = 75, .filtType = 1, .filtFreq = 5, .pitchDrop = 0},
    {.sustain = 0, .release = 53, .waveform = 2, .transpose = 0, .volume = 3, .filtType = 0, .filtFreq = 128, .pitchDrop = 0},
    {.sustain = 0, .release = 70, .waveform = 2, .transpose = 0, .volume = 27, .filtType = 1, .filtFreq = 89, .pitchDrop = 0},
};

int64_t rng = 1;

typedef struct
{
    uint32_t oscPhase;
    int64_t envLevel;
    int64_t envSustain;
    int64_t freq;
    int64_t low, band;
    int64_t paramIndex;
} SynthState;

// UNINITIALIZED DATA (should be filled with zeros)

int64_t SinTable[8192];
int64_t PowTable[8192];
SynthState synthStates[MUSIC_CHANNELS];
int64_t currentRow;

int64_t nonLinearMap(int x)
{
    return PowTable[x] >> 22;
}

void music_init()
{
    const int64_t K = 3294199; // round(math.pi * 2 / 8192 * (1 << 32)) but optimized with matlab
    // note that the sign of the SinTable is inverted (so it goes 0 -> -1 -> 0
    // -> 1 -> 0). This is to have the kick and bass not be in the same phase in
    // parts of the song, where the phase sync caused integer overflow
    int64_t X = (int64_t)(-1) << 32;
    int64_t Y = 0;
    int64_t F = 0xfcd000000;     // 67878804062;     // 2**((64+127-69)/12)*440/32000*(1 << 32)
    const int64_t C = 126684666; // round(2**(-1/12)*(1 << 27))
    for (int i = 0; i < 8192; i++)
    {
        SinTable[i] = Y >> 17;
        X -= (Y * K) >> 32;
        Y += (X * K) >> 32;
        PowTable[i] = F;
        F = (F * C) >> 27;
    }
}

void music_render(int16_t *buffer, int32_t samples)
{
    int64_t localRng = rng;
    int64_t pos = currentRow;
    memset32(buffer, 0, sizeof(int16_t) * samples * 2);
    for (int track = 0; track < MUSIC_CHANNELS; track++)
    {
        SynthState *s = &synthStates[track];
        int64_t envLevel = s->envLevel;
        int64_t envSustain = s->envSustain;
        int64_t freq = s->freq;
        int64_t oscPhase = s->oscPhase;
        int64_t low = s->low;
        int64_t band = s->band;
        int64_t note = noteData[pos];
        if (note)
        {
            s->paramIndex = note >> 7;
        }
        // load params from state
        int64_t paramIndex = s->paramIndex;
        SynthParams *params = &synthParams[track * 2 + paramIndex];
        const int64_t dropFreq = 0x700000; // rounded into nice hex number: 7381975;
        if (note)
        {
            note &= 0x7F;
            envSustain = 1 << 21;
            envLevel = 1 << 21;
            oscPhase = 0;
            freq = PowTable[params->transpose + note];
        }
        int64_t sustain = nonLinearMap(params->sustain);
        int64_t release = nonLinearMap(params->release);
        int64_t pitchDrop = (int64_t)params->pitchDrop;
        int64_t waveform = params->waveform;
        int64_t volume = params->volume;
        int64_t transpose = params->transpose;
        int64_t filtType = params->filtType;
        int64_t filtFreq = params->filtFreq;
        for (int i = 0; i < samples; i++)
        {
            envSustain -= sustain;
            if (envSustain < 0)
            {
                envLevel -= release;
                if (envLevel < 0)
                {
                    envLevel = 0;
                }
            }
            int64_t res;
            oscPhase += freq -= (freq - dropFreq) * pitchDrop >> 16;
            switch (waveform)
            {
            default: // sine
                res = SinTable[(oscPhase >> 19) & 8191];
                break;
            case 1:                                         // saw
                res = (int64_t)(((int32_t)oscPhase) >> 16); // done so that sign bits are shifted in correctly
                break;
            case 2:
                localRng *= 18007;
                res = localRng >> 48;
            }

            int64_t x = (res * volume * envLevel) >> 28;

            low += (filtFreq * band) >> 7;
            int64_t high = ((x - band) >> 1) - low;
            band += (filtFreq * high) >> 7;
            int64_t out;
            switch (filtType)
            {
            default:
            case 0: // high
                out = high;
                break;
            case 1: // band
                out = band;
                break;
            }
            buffer[i * 2 + 1] += out;
            buffer[i * 2] += out;
        }
        s->envLevel = envLevel;
        s->envSustain = envSustain;
        s->freq = freq;
        s->oscPhase = oscPhase;
        s->low = low;
        s->band = band;
        pos += MUSIC_LENGTH;
    }
    rng = localRng;
    currentRow++;
}
