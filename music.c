#include "minimath.h"
#include <stdint.h>
#define SONG_FREQUENCY 32000
#define MUSIC_BPM 144
#define MUSIC_CHANNELS 4
#define MUSIC_LENGTH 1092

typedef struct
{
    uint8_t sustain, release;
    uint8_t waveform, freqMult, volume; // 0-3
    uint8_t filtType, filtFreq;
    uint8_t pitchDrop; // 0-128, 0 no drop
} SynthParams;

static const uint8_t noteData[] = {192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 0, 59, 0, 61, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 57, 0, 52, 0, 0, 0, 64, 0, 0, 61, 0, 0, 59, 0, 0, 0, 0, 0, 0, 0, 57, 0, 59, 0, 61, 0, 57, 0, 59, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 189, 0, 66, 0, 188, 0, 0, 0, 189, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 66, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 64, 0, 192, 0, 0, 0, 192, 0, 0, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 192, 192, 192, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 192, 192, 192, 192, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 0, 0, 64, 0, 192, 192, 192, 192, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 192, 192, 192, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 192, 192, 192, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 0, 64, 64, 64, 64, 64, 64, 192, 192, 192, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

SynthParams synthParams[] = {
    {.sustain = 66 + 3, .release = 32 + 3, .waveform = 0, .freqMult = 8, .volume = 99 / 2, .filtType = 0, .filtFreq = 2, .pitchDrop = 83},
    {.sustain = 122, .release = 122, .waveform = 2, .freqMult = 4, .volume = 9 * 2, .filtType = 1, .filtFreq = 38, .pitchDrop = 0},
    {.sustain = 0 + 3, .release = 68 + 3, .waveform = 1, .freqMult = 4, .volume = 18, .filtType = 0, .filtFreq = 11, .pitchDrop = 0},
    {.sustain = 104 + 3, .release = 0 + 3, .waveform = 1, .freqMult = 4, .volume = 22 * 2, .filtType = 1, .filtFreq = 86, .pitchDrop = 0},
    {.sustain = 0 + 3, .release = 64 + 3, .waveform = 0, .freqMult = 8, .volume = 96 * 2 / 2, .filtType = 1, .filtFreq = 32, .pitchDrop = 0},
    {.sustain = 66 + 3, .release = 32 + 3, .waveform = 1, .freqMult = 1, .volume = 96 * 2, .filtType = 1, .filtFreq = 3, .pitchDrop = 0},
    {.sustain = 0 + 3, .release = 53 + 3, .waveform = 2, .freqMult = 0, .volume = 3, .filtType = 0, .filtFreq = 128, .pitchDrop = 0},
    {.sustain = 0 + 3, .release = 64 + 3, .waveform = 2, .freqMult = 0, .volume = 22 * 2, .filtType = 1, .filtFreq = 81, .pitchDrop = 0},
};

int32_t rng = 1;

typedef struct
{
    uint32_t oscPhase;
    int64_t envLevel;
    int64_t envSustain;
    int64_t freq;
    int64_t low, band;
    int64_t paramIndex;
} SynthState;

// UNINITIALIZED DATA (should be filled with zeros)

int64_t SinTable[8192];
int64_t PowTable[8192];
SynthState synthStates[MUSIC_CHANNELS];
int64_t currentRow;

void music_init()
{
    const int64_t K = 3294199; // round(math.pi * 2 / 8192 * (1 << 32)) but optimized with matlab
    int64_t X = (int64_t)(1) << 32;
    int64_t Y = 0;
    int64_t F = 0x12d00000;       // 67878804062;     // 2**((64+127-69)/12)*440/32000*(1 << 32)
    const int64_t C = 4053909305; // round(2**(-1/12)*(1 << 32))
    for (int i = 0; i < 8192; i++)
    {
        SinTable[i] = Y;
        X -= (Y * K) >> 32;
        Y += (X * K) >> 32;
        PowTable[i] = F;
        F = (F * C) >> 32;
    }
}

void music_render(int16_t *buffer)
{
    int32_t localRng = rng;
    int64_t pos = currentRow;
    int16_t *end = buffer + AI_BUFFER_SIZE/2;

    for (int track = 0; track < MUSIC_CHANNELS; track++)
    {
        SynthState *s = &synthStates[track];
        int64_t oscPhase = s->oscPhase;
        int64_t envLevel = s->envLevel;
        int64_t envSustain = s->envSustain;
        int64_t freq = s->freq;
        int64_t low = s->low;
        int64_t band = s->band;
        int64_t paramIndex = s->paramIndex;
        int64_t note = noteData[pos];
        // load params from state
        if (note)
        {
            paramIndex = note >> 7;
            note &= 0x7F;
            envSustain = 1 << 21;
            envLevel = 1 << 21;
            oscPhase = 0;
            freq = PowTable[note];
        }
        SynthParams *params = &synthParams[track * 2 + paramIndex];
        const int64_t dropFreq = 0x700000 / 8; // rounded into nice hex number: 7381975;
        int64_t freqMult = params->freqMult;
        int64_t sustain = PowTable[params->sustain + 168];
        int64_t release = PowTable[params->release + 168];
        int64_t pitchDrop = params->pitchDrop;
        int64_t waveform = params->waveform;
        int64_t volume = params->volume;
        int64_t filtType = params->filtType;
        int64_t filtFreq = params->filtFreq;

        int16_t *ptr = buffer;
        while (ptr < end)
        {
            envSustain -= sustain;
            if (envSustain < 0)
            {
                envLevel -= release;
                if (envLevel < 0)
                {
                    envLevel = 0;
                }
            }
            int64_t res;
            freq -= (freq - dropFreq) * pitchDrop >> 16;
            oscPhase += freq * freqMult;
            switch (waveform)
            {
            case 0:
                res = SinTable[(uint32_t)oscPhase >> 19];
                break;
            case 1:                                   // saw
                res = (int64_t)(((int32_t)oscPhase)); // done so that sign bits are shifted in correctly
                break;
            default:
            case 2:
                localRng *= 18007;
                res = localRng;
            }

            int64_t x = (res * volume * envLevel) >> 45;

            low += (filtFreq * band) >> 6;
            int64_t high = x - band - low;
            band += (filtFreq * high) >> 8;
            int64_t out = 0;
            // Skip loading previous value during the first track, to clear the buffer
            if (track != 0)
                out = ptr[0];

            switch (filtType)
            {
            case 0: // high
                out += high;
                break;
            default:
            case 1: // band
                out += band;
                break;
            }
            ptr[0] = out;
            ptr[1] = out;
            ptr += 2;
        }
        s->oscPhase = oscPhase;
        s->envLevel = envLevel;
        s->envSustain = envSustain;
        s->freq = freq;
        s->low = low;
        s->band = band;
        s->paramIndex = paramIndex;
        pos += MUSIC_LENGTH;
    }
    rng = localRng;
    currentRow++;
}
