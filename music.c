#include "minimath.h"
#include <stdint.h>
#define SONG_FREQUENCY 44100
#define MUSIC_BPM 144
#define MUSIC_TRACKS 8

static const char bbsong_data[] = "80a50a80a50a805af0a50bf1a73cf3c7g0a80ag0a80ag08ag0a80ag0f137c3578db5db8da5dbfd5a7ce3ce7ce3ec875fg0a80ag0a80ag08ag0a80ag0f137c357";

typedef struct
{
    uint8_t waveform;  // 0-3
    uint8_t transpose; // 0-128, 64 = neutral
    uint8_t detune;    // 0-128, 64 = neutral
    uint8_t volume;    // 0-128
} OscParam;

typedef struct
{
    OscParam oscParams[2];
    uint8_t attack, decay, sustain, release;
    uint8_t noise;
    uint8_t shape;
    uint8_t filtType, filtRes, filtFreq;
    uint8_t pan;
    uint8_t delayTime;   // 0 off, rest are in units of 48th of a beat
    uint8_t delayAmount; // 0-128
    uint8_t pitchDrop;   // 0-128, 0 no drop
    uint8_t reverb;      // 0-128, 0 no reverb
    uint8_t lfoRate;
    uint8_t dropNote;
} SynthParams;

static const uint8_t noteData[][580] = {
    /*{62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 62, 0, 62, 0, 62, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 62, 0, 62, 0, 62, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 62, 0, 62, 0, 62, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 1, 0, 0, 65, 1, 0, 0, 66, 1, 0, 0, 65, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 65, 1, 0, 0, 66, 1, 0, 0, 65, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 65, 1, 0, 0, 66, 1, 0, 0, 65, 1, 0, 0, 0, 0},*/
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 69, 0, 67, 0, 65, 0, 69, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 65, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 69, 0, 67, 0, 69, 0, 74, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 69, 0, 67, 0, 65, 0, 69, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 65, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 69, 0, 67, 0, 69, 0, 74, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 69, 0, 67, 0, 65, 0, 69, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 65, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 69, 0, 67, 0, 69, 0, 74, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 69, 0, 67, 0, 65, 0, 69, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 65, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 69, 0, 67, 0, 69, 0, 74, 0, 0, 0, 62, 0, 0, 65, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 69, 0, 67, 0, 65, 0, 69, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 0, 67, 0, 65, 0, 0, 0, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 1, 0, 0, 65, 1, 0, 0, 66, 1, 0, 0, 65, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 65, 1, 0, 0, 66, 1, 0, 0, 65, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 65, 1, 0, 0, 66, 1, 0, 0, 65, 1, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 62, 0, 62, 0, 62, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 62, 0, 62, 0, 62, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 1, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 62, 0, 62, 0, 62, 0, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 62, 62, 62, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 62, 62, 62, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 62, 62, 62, 62, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 74, 0, 0, 0, 0},
    {38, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 62, 0, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
};

SynthParams params[] = {
    /*    {.oscParams = {{0, 74, 64, 128}, {0, 75, 64, 0}}, .attack = 128, .decay = 128, .sustain = 128, .release = 64, .noise = 0, .shape = 65, .filtType = 3, .filtRes = 128, .filtFreq = 32, .pan = 0, .delayTime = 32, .delayAmount = 0, .pitchDrop = 73, .reverb = 0, .lfoRate = 0, .dropNote = 33},
        {.oscParams = {{1, 36, 64, 63}, {2, 60, 64, 76}}, .attack = 74, .decay = 128, .sustain = 128, .release = 103, .noise = 0, .shape = 82, .filtType = 0, .filtRes = 64, .filtFreq = 20, .pan = 0, .delayTime = 64, .delayAmount = 0, .pitchDrop = 0, .reverb = 2, .lfoRate = 0, .dropNote = 0},*/
    {.oscParams = {{2, 60, 60, 20}, {3, 72, 68, 11}}, .attack = 102, .decay = 64, .sustain = 64, .release = 52, .noise = 0, .shape = 64, .filtType = 1, .filtRes = 128, .filtFreq = 50, .pan = 32, .delayTime = 32, .delayAmount = 32, .pitchDrop = 0, .reverb = 128, .lfoRate = 32, .dropNote = 0},
    {.oscParams = {{1, 36, 64, 63}, {2, 60, 64, 76}}, .attack = 74, .decay = 128, .sustain = 128, .release = 103, .noise = 0, .shape = 82, .filtType = 0, .filtRes = 64, .filtFreq = 20, .pan = 0, .delayTime = 64, .delayAmount = 0, .pitchDrop = 0, .reverb = 2, .lfoRate = 0, .dropNote = 0},
    {.oscParams = {{0, 74, 64, 128}, {0, 75, 64, 0}}, .attack = 128, .decay = 128, .sustain = 128, .release = 64, .noise = 0, .shape = 65, .filtType = 3, .filtRes = 128, .filtFreq = 32, .pan = 0, .delayTime = 32, .delayAmount = 0, .pitchDrop = 73, .reverb = 0, .lfoRate = 0, .dropNote = 33},
    {.oscParams = {{3, 77, 64, 10}, {3, 77, 64, 0}}, .attack = 128, .decay = 27, .sustain = 0, .release = 79, .noise = 26, .shape = 64, .filtType = 1, .filtRes = 128, .filtFreq = 32, .pan = 32, .delayTime = 32, .delayAmount = 0, .pitchDrop = 128, .reverb = 1, .lfoRate = 18, .dropNote = 57},
    {.oscParams = {{0, 64, 64, 1}, {1, 76, 64, 0}}, .attack = 111, .decay = 74, .sustain = 0, .release = 64, .noise = 5, .shape = 64, .filtType = 1, .filtRes = 128, .filtFreq = 119, .pan = 32, .delayTime = 32, .delayAmount = 1, .pitchDrop = 0, .reverb = 68, .lfoRate = 0, .dropNote = 0},
    {.oscParams = {{3, 48, 92, 25}, {0, 60, 51, 23}}, .attack = 8, .decay = 33, .sustain = 128, .release = 3, .noise = 1, .shape = 85, .filtType = 0, .filtRes = 64, .filtFreq = 90, .pan = 128, .delayTime = 32, .delayAmount = 120, .pitchDrop = 0, .reverb = 128, .lfoRate = 49, .dropNote = 0},
    {.oscParams = {{2, 84, 70, 74}, {2, 72, 49, 66}}, .attack = 89, .decay = 92, .sustain = 24, .release = 64, .noise = 0, .shape = 94, .filtType = 1, .filtRes = 25, .filtFreq = 67, .pan = 32, .delayTime = 32, .delayAmount = 0, .pitchDrop = 0, .reverb = 64, .lfoRate = 0, .dropNote = 0},
    {.oscParams = {{2, 60, 29, 6}, {2, 72, 95, 9}}, .attack = 0, .decay = 128, .sustain = 1, .release = 64, .noise = 6, .shape = 64, .filtType = 2, .filtRes = 64, .filtFreq = 83, .pan = 12, .delayTime = 32, .delayAmount = 0, .pitchDrop = 0, .reverb = 41, .lfoRate = 64, .dropNote = 0},
};

uint16_t reverbTimes[2][8] = {
    {1116, 1188, 1276, 1356, 1422, 1492, 1556, 1618},
    {1140, 1212, 1300, 1380, 1446, 1516, 1580, 1642}};

enum EnvState
{
    Attacking = 0,
    Decaying = 1,
    Sustaining = 2,
    Releasing = 3,
};

typedef struct
{
    int64_t low, band;
} FiltState;

typedef struct
{
    int64_t oscStates[2][2];
    int64_t tmp;
    int64_t envLevel;
    int64_t envState;
    int64_t note;
    int64_t drop;
    FiltState filtState[2];
    struct
    {
        // int64_t buffer[65536][2];
        uint16_t index;
    } delayState;
    int64_t lfoPhase;
    uint64_t rng;
} SynthState;

typedef struct
{
    int64_t buffer[2048];
    int64_t dampState;
} ReverbLine;

typedef struct
{
    struct
    {
        ReverbLine lines[8];
        int64_t dcIn, dcState;
    } channels[2];
    int32_t index;
} Reverb;

// UNINITIALIZED DATA (should be filled with zeros)

int64_t SinTable[8192];
int64_t PowTable[256];
SynthState synthStates[8];
Reverb reverb;
int sampleWithinRow;
int currentRow;

int64_t waveshape(int64_t value, int64_t amount)
{
    int64_t absVal = value < 0 ? -value : value;
    return value * (amount << 16) / (((128 - amount) << 16) + (2 * amount - 128) * absVal);
}

int64_t nonLinearMap(int x)
{
    return PowTable[x + 64] >> 12;
}

int64_t stepFilt(FiltState *f, SynthParams *p, int64_t x)
{
    int64_t freq2 = (int64_t)(p->filtFreq) * (int64_t)(p->filtFreq);
    f->low += (freq2 * f->band) >> 14;
    int64_t high = ((int64_t)p->filtRes * (x - f->band) >> 7) - f->low;
    f->band += (freq2 * high) >> 14;
    switch (p->filtType)
    {
    default: // low
        return f->low;
    case 1: // high
        return high;
    case 2: // band
        return f->band;
    case 3: // notch
        return high + f->low;
    }
}

void stepOsc(int64_t *oscStates, OscParam *p, int64_t note, int64_t drop, int64_t dropNote, int64_t shape, int64_t *out)
{
    int64_t freq = PowTable[(p->transpose + note) & 255];
    int64_t dropFreq = PowTable[dropNote + 64];
    int64_t detune = (int64_t)p->detune - 64;
    for (int i = 0; i < 2; i++)
    {
        int64_t F = freq + ((detune * 983220 * freq) >> 32); // (2**(1/24)-1)* (1 << 25)
        F = (((F - dropFreq) * drop) >> 27) + dropFreq;
        oscStates[i] = (oscStates[i] + F) & 0xFFFFFFFF;
        switch (p->waveform)
        {
        default: // sine
            out[i] = SinTable[(oscStates[i] >> 19) & 8191];
            break;
        case 1: // square
            out[i] = (oscStates[i] & 0x80000000) ? 65536 : -65536;
            break;
        case 2:                                                     // saw
            out[i] = (int64_t)(((int32_t)oscStates[i]) >> 16) << 1; // done so that sign bits are shifted in correctly
            break;
        case 3: // triangle
            int64_t t = (oscStates[i] - 0x80000000) << 1;
            if (t < 0)
                t = -t;
            out[i] = (t >> 15) - 65536;
            break;
        }
        out[i] = waveshape(out[i], shape);
        out[i] = (out[i] * (int64_t)p->volume) >> 7;
        detune = -detune;
    }
}

int64_t Next(uint64_t *r)
{
    if (*r == 0)
        *r = 1;
    *r ^= (*r << 13);
    *r ^= (*r >> 7);
    *r ^= (*r << 17);
    return (int64_t)*r;
}

void stepReverb(int64_t x[2], int64_t output[2])
{
    const int64_t pregain = 6400;
    const int64_t feedback = 64000;
    for (int i = 0; i < 2; i++)
    {
        for (int j = 0; j < 8; j++)
        {
            ReverbLine *line = &reverb.channels[i].lines[j];
            uint16_t delIndex = (reverb.index - reverbTimes[i][j]) & 2047;
            int64_t delSignal = line->buffer[delIndex];
            output[i] += delSignal;
            line->dampState = (line->dampState + delSignal) >> 1;
            line->buffer[reverb.index] = (line->dampState * feedback + x[i] * pregain) >> 16;
        }
        reverb.channels[i].dcState = output[i] + ((65280 * reverb.channels[i].dcState) >> 16) - reverb.channels[i].dcIn;
        reverb.channels[i].dcIn = output[i];
        output[i] = reverb.channels[i].dcState;
    }
    reverb.index = (reverb.index + 1) & 2047;
}

void music_init()
{
    const int64_t K = 3294199; // round(math.pi * 2 / 8192 * (1 << 32)) but optimized with matlab
    int64_t X = (int64_t)(1) << 32;
    int64_t Y = 0;
    for (int i = 0; i < 8192; i++)
    {
        SinTable[i] = Y >> 16;
        X -= (Y * K) >> 32;
        Y += (X * K) >> 32;
    }

    int64_t F = 49254460997;     // 2**((64+127-69)/12)*440/44100*(1 << 32)
    const int64_t C = 126684666; // round(2**(-1/12)*(1 << 27))
    for (int i = 0; i < 256; i++)
    {
        PowTable[255 - i] = F;
        F = (F * C) >> 27;
    }

    memset32(&reverb, 0, sizeof(reverb));
    memset32(synthStates, 0, sizeof(SynthState) * MUSIC_TRACKS);
    sampleWithinRow = 0;
    currentRow = 0;
}

void music_render(int16_t *buffer, int32_t samples)
{
    for (int i = 0; i < samples; i++)
    {
        if (!sampleWithinRow && currentRow < 580)
        {
            // trigger or release notes
            for (int track = 0; track < MUSIC_TRACKS; track++)
            {
                SynthState *s = &synthStates[track];
                uint8_t note = noteData[track][currentRow];
                if (note == 1)
                    continue;
                if (note == 0)
                { // release note
                    s->envState = Releasing;
                    continue;
                }
                s->note = note;
                s->drop = 1 << 27;
                s->oscStates[0][0] = 0;
                s->oscStates[0][1] = 0;
                s->oscStates[1][0] = 0;
                s->oscStates[1][1] = 0;
                s->envLevel = 0;
                s->envState = Attacking;
            }
            currentRow++;
            sampleWithinRow = 44100 * 60 / (MUSIC_BPM * 4);
        }
        int64_t totalOut[2] = {0, 0};
        int64_t totalAux[2] = {0, 0};
        for (int track = 0; track < MUSIC_TRACKS; track++)
        {
            int64_t out[2] = {0, 0};
            int64_t aux[2] = {0, 0};
            SynthState *c = &synthStates[track];
            SynthParams *p = &params[track];

            if (c->envState == Attacking)
            {
                c->envLevel += nonLinearMap(p->attack);
                if (c->envLevel >= 1 << 24)
                {
                    c->envLevel = 1 << 24;
                    c->envState++;
                }
            }
            if (c->envState == Decaying)
            {
                c->envLevel -= nonLinearMap(p->decay);
                if (c->envLevel <= ((int64_t)p->sustain) << 17)
                {
                    c->envLevel = ((int64_t)p->sustain) << 17;
                    c->envState++;
                }
            }
            if (c->envState == Releasing)
            {
                c->envLevel -= nonLinearMap(p->release);
                if (c->envLevel < 0)
                {
                    c->envLevel = 0;
                }
            }
            int64_t e = c->envLevel;
            for (int i = 0; i < 2; i++)
            {
                int64_t oscO[2] = {0, 0};
                stepOsc(c->oscStates[i], &p->oscParams[i], c->note, c->drop, p->dropNote, (int64_t)p->shape, oscO);
                out[0] += oscO[0];
                out[1] += oscO[1];
            }
            c->drop = (c->drop * (65536 - (int64_t)p->pitchDrop)) >> 16;
            for (int i = 0; i < 2; i++)
            {
                out[i] += (((int64_t)((c->rng % 65536)) - 32768) * (int64_t)p->noise) >> 7;
                out[i] = (out[i] * e) >> 24;
                out[i] = stepFilt(&c->filtState[i], p, out[i]);
            }
            c->lfoPhase += PowTable[p->lfoRate] & 0xFFFFFFFF;
            int64_t pan = (int64_t)p->pan * SinTable[(c->lfoPhase >> 19) & 8191] + (1 << 23);
            out[0] = (out[0] * ((1 << 24) - pan)) >> 24;
            out[1] = (out[1] * pan) >> 24;
            //  ping pong delay
            uint16_t index = c->delayState.index - (uint16_t)((p->delayTime + 1) * 44100 * 60 / (MUSIC_BPM * 48));
            // out[0] += (c->delayState.buffer[index][1] * (int64_t)p->delayAmount) >> 7;
            // out[1] += (c->delayState.buffer[index][0] * (int64_t)p->delayAmount) >> 7;
            // c->delayState.buffer[c->delayState.index][0] = out[0];
            // c->delayState.buffer[c->delayState.index][1] = out[1];
            // c->delayState.index++;
            aux[0] = (out[0] * (int64_t)p->reverb) >> 7;
            aux[1] = (out[1] * (int64_t)p->reverb) >> 7;

            totalOut[0] += out[0];
            totalOut[1] += out[1];
            totalAux[0] += aux[0];
            totalAux[1] += aux[1];
        }
        //  apply reverb
        int64_t reverbOut[2] = {0, 0};
        stepReverb(totalAux, reverbOut);
        //    add to output and write
        for (int j = 0; j < 2; j++)
        {
            int64_t sample = totalOut[j] + reverbOut[j];
            if (sample > 32767)
                sample = 32767;
            if (sample < -32768)
                sample = -32768;
            buffer[i * 2 + j] = (int16_t)(sample);
        }
        sampleWithinRow--;
    }
}
